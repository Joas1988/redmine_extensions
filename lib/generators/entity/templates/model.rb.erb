class <%= model_name %> < ActiveRecord::Base
  include Redmine::SafeAttributes

  <%= 'belongs_to :project' if project? %>
  <%= 'belongs_to :author, class_name: \'User\', foreign_key: \'author_id\'' if author? %>

  scope :visible, lambda { |*args|
    where(<%= model_name %>.visible_condition(args.shift || User.current, *args)<%= '.joins(:project)' if project? %>)
  }

  <%= 'validates :project_id, :presence => true' if project? %>
  <%= 'validates :author_id, :presence => true' if author? %>

  attr_protected :id

  <%- if safe_columns.any? -%>
  safe_attributes <%= safe_columns.collect{|column_name| "'#{column_name}'"}.join(', ') %>
  <%- end -%>

  def self.visible_condition(user, options={})
  <%- if project? -%>
    Project.allowed_to_condition(user, :<%= view_permission %>, options)
  <%- else -%>
    '1=1'
  <%- end -%>
  end

  def self.css_icon
    'icon icon-user'
  end

  def visible?(user = nil)
    user ||= User.current
    user.allowed_to?(:<%= view_permission %>, <%= project? ? 'self.project' : 'nil' %>, global: true)
  end

  def editable?(user = nil)
    user ||= User.current
    user.allowed_to?(:<%= edit_permission %>, <%= project? ? 'self.project' : 'nil' %>, global: true)
  end

end
